<!DOCTYPE html>  <html> <head>   <title>faviconbuilder.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="faviconbuilder.html">                 faviconbuilder.coffee               </a>                                           <a class="source" href="test.html">                 test.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               faviconbuilder.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>FAVICON BUILDER
@version 0.1
@author M.Paraiso</p>             </td>             <td class="code">               <div class="highlight"><pre>

</pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>@description EN</p>             </td>             <td class="code">               <div class="highlight"><pre>


<span class="nx">console</span><span class="o">?=</span>
  <span class="nx">log</span><span class="o">:-&gt;</span>

<span class="nb">Array</span><span class="p">.</span><span class="nv">prototype.split = </span><span class="nf">(index)-&gt;</span>
  <span class="k">if</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">q = </span><span class="k">this</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">index</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span><span class="nx">q</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>namespaces #</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="nv">App = </span><span class="p">{</span>
  <span class="nx">Views</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Models</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Controllers</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Collections</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Utils</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Lib</span><span class="o">:</span><span class="p">{}</span>
  <span class="nx">Ajax</span><span class="o">:</span><span class="p">{}</span>
  <span class="p">}</span>

</pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>UTILITIES</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">DefaultColors</span>
  <span class="nx">constructor</span><span class="o">:-&gt;</span>
    <span class="vi">@colors =</span>
      <span class="p">[</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Eraser&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;White&quot;</span><span class="p">,</span><span class="s2">&quot;#FFF&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Gray2&quot;</span><span class="p">,</span><span class="s2">&quot;#DDD&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Gray1&quot;</span><span class="p">,</span><span class="s2">&quot;#AAA&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Gray2&quot;</span><span class="p">,</span><span class="s2">&quot;#777&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span><span class="s2">&quot;#000&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="s2">&quot;#900&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="s2">&quot;#F00&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="s2">&quot;#F99&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Red&quot;</span><span class="p">,</span><span class="s2">&quot;#FDD&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="s2">&quot;#090&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="s2">&quot;#0F0&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="s2">&quot;#9F9&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Green&quot;</span><span class="p">,</span><span class="s2">&quot;#DFD&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="s2">&quot;#009&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="s2">&quot;#00F&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="s2">&quot;#99F&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Blue&quot;</span><span class="p">,</span><span class="s2">&quot;#DDF&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Yellow&quot;</span><span class="p">,</span><span class="s2">&quot;#FF0&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Yellow&quot;</span><span class="p">,</span><span class="s2">&quot;#F90&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Cyan&quot;</span><span class="p">,</span><span class="s2">&quot;#0FF&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Cyan&quot;</span><span class="p">,</span><span class="s2">&quot;#099&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Magenta&quot;</span><span class="p">,</span><span class="s2">&quot;#F0F&quot;</span><span class="p">)</span>
        <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Magenta&quot;</span><span class="p">,</span><span class="s2">&quot;#909&quot;</span><span class="p">)</span>
      <span class="p">]</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@type)-&gt;</span>
    <span class="nx">@datas</span><span class="o">=</span><span class="kc">null</span>
    <span class="nx">@target</span><span class="o">=</span><span class="kc">null</span>
    <span class="nx">@currentTarget</span><span class="o">=</span><span class="kc">null</span>

</pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>App.Utils.EventDispatcher</h2>

<h3>FR :</h3>

<p><li>imite le system d'évenements <strong>flash</strong>.
 <li>Etend Object.prototype
 <li> les objets implementent 3 méthodes : dispatch , addListener , removeListener
 <li> l'objet Event du DOM est utilisé par défaut pour transmettre les messages.
 * on peut récuperer des données de l'évenement grace au champ datas de l'objet event
 * currentTarget et target permettent de savoir dans quel context l'évenement a été dispatché ( émit )</p>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span>
    <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@parent)-&gt;</span>
    <span class="nv">listeners : </span><span class="p">[]</span>
    <span class="nv">addListener : </span><span class="nf">(eventName,listener)-&gt;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span><span class="s2">&quot;eventName&quot;</span><span class="o">:</span><span class="nx">eventName</span><span class="p">,</span><span class="s2">&quot;listener&quot;</span><span class="o">:</span><span class="nx">listener</span><span class="p">})</span>
    <span class="nv">dispatch : </span><span class="nf">(event,datas)-&gt;</span>
</pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>throw new Error("event should be an instance of Event") unless event instanceof Event</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nv">event.target = event.currentTarget = </span> <span class="nx">@parent</span>
      <span class="nv">event.datas = </span><span class="nx">datas</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span>
        <span class="nx">i</span><span class="p">.</span><span class="nx">listener</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">event</span><span class="p">.</span><span class="nx">type</span> <span class="o">!=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">eventName</span>
    <span class="nv">removeListener : </span><span class="nf">(eventName,listener)-&gt;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">listeners</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">({</span><span class="s2">&quot;eventName&quot;</span><span class="o">:</span><span class="nx">eventName</span><span class="p">,</span><span class="s2">&quot;listener&quot;</span><span class="o">:</span><span class="nx">listener</span><span class="p">}),</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">DefaultMenu</span>
  <span class="nx">items</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Undo&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;undo&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Restore the grid to the previous state&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Redo&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;redo&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Restore the grid to the next state&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Empty grid&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;emptygrid&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Create a new blank grid&quot;</span><span class="p">}</span>
    <span class="c1">#{label:&quot;16x16 grid&quot;,action:&quot;changegridsize&quot;,title:&#39;Change grid size&#39;,datas:{rows:16,columns:16}}</span>
    <span class="c1">#{label:&quot;32x32 grid&quot;,action:&quot;changegridsize&quot;,title:&#39;Change grid size&#39;,datas:{rows:32,columns:32}}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Export to png&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;exporttopng&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Export image as png in a new window (not available in Internet explorer)&quot;</span><span class="p">,</span><span class="nx">datas</span><span class="o">:</span><span class="p">{</span><span class="nx">param</span><span class="o">:</span><span class="s2">&quot;whatever&quot;</span><span class="p">}}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Save to local&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;savetolocal&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Save icon to local storage (not available in all browers !!) \n Click on restore to load the saved icon.&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;Restore from local&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;restorefromlocal&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Restore previously saved icon.&quot;</span><span class="p">,</span><span class="nx">datas</span><span class="o">:</span><span class="p">{}}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;thickbox test&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;showthickbox&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;Show thick box , just a javascript CSS test , no special functionalities&quot;</span><span class="p">}</span>
  <span class="p">]</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Toolbox</span>
  <span class="nx">tools</span><span class="o">:</span><span class="p">[</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;pen&quot;</span><span class="p">,</span><span class="nx">src</span><span class="o">:</span><span class="s2">&quot;img//pen.png&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;drawpoint&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;pen&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;bucket&quot;</span><span class="p">,</span><span class="nx">src</span><span class="o">:</span><span class="s2">&quot;img//bucket.png&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;drawfill&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;bucket&quot;</span><span class="p">}</span>
    <span class="p">{</span><span class="nx">label</span><span class="o">:</span><span class="s2">&quot;rubber&quot;</span><span class="p">,</span><span class="nx">src</span><span class="o">:</span><span class="s2">&quot;img//rubber.png&quot;</span><span class="p">,</span><span class="nx">action</span><span class="o">:</span><span class="s2">&quot;erase&quot;</span><span class="p">,</span><span class="nx">title</span><span class="o">:</span><span class="s2">&quot;rubber&quot;</span><span class="p">}</span>
  <span class="p">]</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Iterator</span> <span class="k">extends</span> <span class="nb">Array</span>
    <span class="nx">constructor</span><span class="o">:-&gt;</span>
      <span class="nx">@push</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">arguments</span>
      <span class="vi">@iter = </span><span class="mi">0</span>
    <span class="nx">next</span><span class="o">:-&gt;</span>
       <span class="err">@</span><span class="p">[</span><span class="o">++</span><span class="nx">@iter</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@iter</span> <span class="o">&lt;</span> <span class="nx">@length</span><span class="o">-</span><span class="mi">1</span>
    <span class="nx">previous</span><span class="o">:-&gt;</span>
       <span class="err">@</span><span class="p">[</span><span class="o">--</span><span class="nx">@iter</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@iter</span><span class="o">&gt;</span><span class="mi">0</span>
    <span class="nx">hasNext</span><span class="o">:-&gt;</span>
      <span class="k">if</span> <span class="err">@</span><span class="p">[</span><span class="nx">@iter</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="kc">true</span>
      <span class="k">else</span>
        <span class="kc">false</span>
    <span class="nx">hasPrevious</span><span class="o">:-&gt;</span>
      <span class="k">if</span> <span class="err">@</span><span class="p">[</span><span class="nx">@iter</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="kc">true</span>
      <span class="k">else</span>
        <span class="kc">false</span>


</pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <h2>DRAWING TOOLS</h2>             </td>             <td class="code">               <div class="highlight"><pre>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Tool</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@context,@point)-&gt;</span>
  <span class="nx">execute</span><span class="o">:-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">BucketTool</span> <span class="k">extends</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Tool</span>

  <span class="nx">MAXITERATION</span><span class="o">:</span><span class="mi">1000</span>
  <span class="nx">factor</span><span class="o">:</span><span class="mi">1</span>
  <span class="nv">fill : </span><span class="nf">(ctx,pixel, colCible, colRep)-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;bucket fill&quot;</span><span class="p">,</span><span class="nx">arguments</span>
    <span class="nv">P = </span><span class="p">[]</span>
    <span class="nv">max = </span><span class="nx">@MAXITERATION</span>
    <span class="k">if</span> <span class="nx">@getColorAtPixel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">pixel</span><span class="p">)</span><span class="o">!=</span><span class="nx">colCible</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">null</span>
    <span class="nx">P</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">pixel</span><span class="p">)</span>
    <span class="k">while</span>  <span class="nx">P</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">max</span> <span class="o">&gt;=</span><span class="mi">0</span>
      <span class="o">--</span><span class="nx">max</span>
      <span class="nv">currentpixel = </span><span class="nx">P</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">currentpixel</span>
      <span class="nx">@fillRect</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">currentpixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="nx">currentpixel</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span><span class="nx">colRep</span><span class="p">,</span><span class="nx">@factor</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">@isInCanvas</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">currentpixel</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">@getColorAtPixel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">@up</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span> <span class="o">==</span> <span class="nx">colCible</span> <span class="k">then</span> <span class="nx">P</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@up</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">@getColorAtPixel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">@down</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span> <span class="o">==</span> <span class="nx">colCible</span> <span class="k">then</span> <span class="nx">P</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@down</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">@getColorAtPixel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">@right</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span> <span class="o">==</span> <span class="nx">colCible</span> <span class="k">then</span> <span class="nx">P</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@right</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span>
        <span class="k">if</span> <span class="nx">@getColorAtPixel</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">@left</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span> <span class="o">==</span> <span class="nx">colCible</span> <span class="k">then</span> <span class="nx">P</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@left</span><span class="p">(</span><span class="nx">currentpixel</span><span class="p">))</span>
    <span class="k">return</span>

  <span class="nx">fillRect</span><span class="o">:</span><span class="nf">(ctx,x,y,_color,_factor)-&gt;</span>
    <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillCell</span><span class="p">({</span><span class="nx">row</span><span class="o">:</span><span class="nx">x</span><span class="p">,</span><span class="nx">column</span><span class="o">:</span><span class="nx">y</span><span class="p">,</span><span class="nx">color</span><span class="o">:</span><span class="p">{</span><span class="nx">color</span><span class="o">:</span><span class="nx">_color</span><span class="p">},</span><span class="nx">factor</span><span class="o">:</span><span class="nx">_factor</span><span class="p">})</span>
    <span class="k">return</span>
  <span class="nx">down</span> <span class="o">:</span><span class="nf">(pixel)-&gt;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="o">-</span><span class="nx">@factor</span><span class="p">}</span>

  <span class="nx">up</span><span class="o">:</span><span class="nf">(pixel)-&gt;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="o">+</span><span class="nx">@factor</span><span class="p">}</span>

  <span class="nx">right</span> <span class="o">:</span><span class="nf">(pixel)-&gt;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="o">+</span><span class="nx">@factor</span><span class="p">,</span><span class="nx">y</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span>

  <span class="nx">left</span> <span class="o">:</span><span class="nf">(pixel)-&gt;</span>
    <span class="k">return</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="o">-</span><span class="nx">@factor</span><span class="p">,</span><span class="nx">y</span><span class="o">:</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span>

  <span class="nx">getColorAtPixel</span><span class="o">:</span><span class="nf">(ctx,pixel)-&gt;</span>
    <span class="k">if</span> <span class="nx">@isInCanvas</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="nx">pixel</span><span class="p">)</span> <span class="o">and</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">][</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">]</span><span class="o">?</span>
      <span class="nv">result = </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span><span class="p">][</span><span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span><span class="p">].</span><span class="nx">color</span>
    <span class="k">return</span> <span class="nx">result</span>

  <span class="nx">rgbArrayToCssColorString</span><span class="o">:</span><span class="nf">(array)-&gt;</span>
    <span class="nv">result = </span><span class="s2">&quot;rgb(#{array[0]},#{array[1]},#{array[2]})&quot;</span>
    <span class="k">return</span> <span class="nx">result</span>

  <span class="nv">isInCanvas : </span><span class="nf">(ctx,pixel)-&gt;</span>
    <span class="nv">result = </span><span class="p">((</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">pixel</span><span class="p">.</span><span class="nx">x</span> <span class="o">&lt;</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="nx">pixel</span><span class="p">.</span><span class="nx">y</span> <span class="o">&lt;</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">columns</span><span class="p">))</span>
    <span class="k">return</span> <span class="nx">result</span>



</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>MODELS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@title=&quot;Eraser&quot;,@value=&quot;&quot;,@alpha=1)-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Application</span>
  <span class="nx">constructor</span><span class="o">:-&gt;</span>
    <span class="nx">@children</span><span class="o">=</span><span class="p">[]</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;modelupdate&quot;</span><span class="p">,</span><span class="nx">@update</span><span class="p">)</span>
  <span class="nx">update</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;update&quot;</span><span class="p">),</span><span class="err">@</span><span class="p">)</span>
  <span class="nv">currentColor : </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span><span class="s2">&quot;rgb(0,0,0)&quot;</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
  <span class="nv">favIconGridModel : </span><span class="kc">null</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Cell</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="p">(</span><span class="nx">@color</span><span class="o">=</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;empty&quot;</span><span class="p">,</span><span class="s2">&quot;&quot;</span><span class="p">),</span><span class="nx">@row</span><span class="p">,</span><span class="nx">@column</span><span class="p">)</span><span class="o">-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Grid</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@rows=16,@columns=16,@version,@title)-&gt;</span> <span class="c1"># crée le modèle de grille</span>
    <span class="vi">@grid = </span><span class="p">[]</span>
    <span class="nx">@fillGridBlank</span><span class="p">()</span>
  <span class="nx">fillGridBlank</span><span class="o">:-&gt;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@rows</span><span class="p">]</span>
      <span class="nx">@grid</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span> <span class="nx">@columns</span><span class="p">]</span>
        <span class="nx">@grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">]</span><span class="o">?=</span> <span class="k">new</span>  <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Cell</span><span class="p">()</span>
  <span class="nx">fillCell</span><span class="o">:</span><span class="nf">(params)-&gt;</span>
    <span class="nx">@grid</span><span class="p">[</span><span class="nx">params</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">params</span><span class="p">.</span><span class="nx">column</span><span class="p">].</span><span class="nv">color = </span><span class="nx">params</span><span class="p">.</span><span class="nx">color</span>
    <span class="nx">@grid</span><span class="p">[</span><span class="nx">params</span><span class="p">.</span><span class="nx">row</span><span class="p">][</span><span class="nx">params</span><span class="p">.</span><span class="nx">column</span><span class="p">].</span><span class="nv">alpha = </span><span class="mi">1</span>
  <span class="nx">emptyGrid</span><span class="o">:-&gt;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@rows</span><span class="p">]</span>
      <span class="nx">@grid</span><span class="p">.</span><span class="nx">push</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@columns</span><span class="p">]</span>
        <span class="nx">@grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nv">color = </span><span class="s2">&quot;&quot;</span>
        <span class="nx">@grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nv">alpha = </span><span class="mi">1</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Title</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@value,@targetId)-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ColorSelector</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="p">(</span><span class="vi">@colors= </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">DefaultColors</span><span class="p">().</span><span class="nx">colors</span><span class="p">,</span><span class="nx">@currentColor</span><span class="o">=</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;Black&quot;</span><span class="p">,</span><span class="s2">&quot;rgb(0,0,0)&quot;</span><span class="p">))</span><span class="o">-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CanvasPreview</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@targetId,@model,@factor=4)-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">FactorSelector</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@targetId,@factor,@selectors=[1,2,3,4])-&gt;</span>
    
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Menu</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@items=[],@targetId)-&gt;</span>
  <span class="nx">addItem</span><span class="o">:</span><span class="nf">(item)-&gt;</span>
    <span class="nx">@items</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
  <span class="nx">removeItem</span><span class="o">:</span><span class="nf">(item)-&gt;</span>
    <span class="nx">@items</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">@items</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">item</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">History</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="p">(</span><span class="vi">@iterator = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Iterator</span><span class="p">())</span><span class="o">-&gt;</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Toolbox</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@tools)-&gt;</span>
    <span class="vi">@currentTool = </span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="nx">@tools</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">label</span><span class="p">}</span>
  
</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h2>VIEWS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">View</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">of</span> <span class="k">this</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">child</span><span class="p">].</span><span class="nx">render</span><span class="o">?</span><span class="p">()</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Cell</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model,@targetId)-&gt;</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@el = </span><span class="s2">&quot;&lt;div name =&#39;cell&#39; &quot;</span>
    <span class="k">if</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="kc">null</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="nx">@el</span><span class="o">+=</span> <span class="s2">&quot; class=&#39;emptyCell &#39; &quot;</span>
    <span class="k">else</span>
      <span class="nx">@el</span><span class="o">+=</span> <span class="s2">&quot; style=&#39;background-color:#{@model.color.value};&#39; &quot;</span>
    <span class="nx">@el</span><span class="o">+=</span> <span class="s2">&quot; data-row=&#39;#{@model.row}&#39; data-column=&#39;#{@model.column}&#39; &quot;</span>
    <span class="nx">@el</span><span class="o">+=</span> <span class="s2">&quot; &gt; &lt;/div&gt; &quot;</span>
    <span class="k">if</span> <span class="nx">targetId</span><span class="o">?</span>
      <span class="vi">@targetId.innerHTML = </span><span class="nx">@el</span>
    <span class="k">return</span> <span class="k">this</span>
  

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Grid</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@divTargetId,@model,@cellStyle=&quot;cell&quot;,@emptyCellStyle=&quot;emptyCell&quot;,@pen={})-&gt;</span>
    <span class="vi">@drawMode = </span><span class="kc">false</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;drawmodechange&quot;</span><span class="p">,</span><span class="nx">@setDrawMode</span><span class="p">)</span>
    <span class="vi">@divTargetId.classes = </span><span class="nx">@divTargetId</span><span class="p">.</span><span class="nx">className</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="nv">gridModel = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span>
    <span class="vi">@divTargetId.innerHTML = </span><span class="s2">&quot;&quot;</span>
    <span class="vi">@divTargetId.className = </span><span class="s2">&quot; #{@divTargetId.classes } _#{gridModel.columns}&quot;</span>
    <span class="vi">@el = </span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">row</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">rows</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">column</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">columns</span><span class="p">]</span>
        <span class="nv">cell = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">row</span><span class="p">][</span><span class="nx">column</span><span class="p">].</span><span class="nx">color</span><span class="p">,</span><span class="nx">row</span><span class="p">,</span><span class="nx">column</span><span class="p">))</span>
        <span class="nv">element = </span><span class="nx">cell</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
        <span class="nx">@el</span> <span class="o">+=</span> <span class="nx">element</span>
    <span class="nx">@divTargetId</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">+=</span> <span class="nx">@el</span>
    <span class="nx">@divTargetId</span><span class="p">.</span><span class="nx">onmouseup</span> <span class="o">=</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="vi">@drawMode = </span><span class="kc">false</span>
      <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;renderpreview&quot;</span><span class="p">),{})</span>
      <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;pushinhistory&quot;</span><span class="p">),{})</span>
</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>@divTargetId.onmousemove = </p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="vi">@divTargetId.onmousedown = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;mousedown&quot;</span> <span class="k">then</span> <span class="vi">@drawMode = </span><span class="kc">true</span>
      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span><span class="o">==</span><span class="s2">&quot;cell&quot;</span> <span class="o">and</span> <span class="nx">@drawMode</span> <span class="o">==</span> <span class="kc">true</span>
        <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;clickcell&quot;</span><span class="p">),{</span><span class="nx">element</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span><span class="nx">tool</span><span class="o">:</span><span class="s2">&quot;pen&quot;</span><span class="p">,</span><span class="nx">width</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span><span class="nx">color</span><span class="o">:</span><span class="nx">@pen</span><span class="p">.</span><span class="nx">color</span><span class="p">,</span><span class="nx">row</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;data-row&quot;</span><span class="p">),</span><span class="nx">column</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;data-column&quot;</span><span class="p">)})</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="k">return</span> <span class="k">this</span>
  <span class="nx">fillCell</span><span class="o">:</span><span class="nf">(e)-&gt;</span> <span class="c1"># speed up the grid rendering when filling one cell </span>
</pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>tool = @model.toolbox.currentTool.value</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nv">color = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">value</span>
    <span class="k">if</span>  <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="kc">undefined</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">e.datas.element.style.backgroundColor = </span><span class="nx">color</span>
      <span class="nv">e.datas.element.className  = </span><span class="s2">&quot;&quot;</span>
    <span class="k">else</span>
      <span class="nv">e.datas.element.style.backgroundColor = </span><span class="kc">null</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">className</span>  <span class="o">+=</span> <span class="s2">&quot; #{@emptyCellStyle}&quot;</span>



  <span class="nx">setDrawMode</span><span class="o">:</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@drawMode = </span><span class="nx">event</span><span class="p">.</span><span class="nx">datas</span>
  <span class="nx">setPenColor</span><span class="o">:</span><span class="p">(</span><span class="nx">color</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@pen.color = </span><span class="nx">color</span> <span class="c1"># color object</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Application</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@controller,@targetId)-&gt;</span>
    <span class="vi">@controller.view = </span><span class="err">@</span>
    <span class="vi">@children = </span><span class="p">[]</span>
  <span class="nx">addChild</span><span class="o">:</span><span class="nf">(view)-&gt;</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">view</span><span class="p">)</span>
  <span class="nx">removeChild</span><span class="o">:</span><span class="nf">(view)-&gt;</span>
    <span class="nx">@children</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">@children</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">view</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@children</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">render</span><span class="o">?</span><span class="p">()</span>
</pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Title</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model)-&gt;</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@el= </span><span class="nx">@model</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">italics</span><span class="p">()</span>
    <span class="vi">@model.targetId.innerHTML  = </span><span class="nx">@el</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="s2">&quot;Click here to change the grid title&quot;</span><span class="p">)</span>
    <span class="vi">@model.targetId.onclick = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;contenteditable&quot;</span><span class="p">,</span><span class="kc">true</span><span class="p">)</span>
      <span class="nv">e.currentTarget.style.border = </span><span class="s2">&quot;1px solid #00EEFF&quot;</span>
      <span class="nv">e.currentTarget.style.borderRadius = </span><span class="s2">&quot;2px&quot;</span>
      <span class="nv">e.currentTarget.style.padding= </span><span class="s2">&quot;2px 5px 2px 5px&quot;</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">onblur</span> <span class="o">=</span><span class="vi">@model.targetId.onkeypress = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;keypress&quot;</span> <span class="o">and</span> <span class="nx">e</span><span class="p">.</span><span class="nx">which</span> <span class="o">!=</span> <span class="mi">13</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;contenteditable&quot;</span><span class="p">,</span><span class="kc">false</span><span class="p">)</span>
      <span class="nv">e.currentTarget.style.border = </span><span class="s2">&quot;&quot;</span>
      <span class="vi">@model.value = </span><span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">innerText</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>  <span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">innerText</span><span class="p">.</span><span class="nx">trim</span><span class="p">()</span> <span class="k">else</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">value</span>
      <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;titlechanged&quot;</span><span class="p">),</span><span class="nx">@model</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
      
    <span class="nx">@model</span><span class="p">.</span><span class="nx">onkeypress</span>
    <span class="k">return</span> <span class="k">this</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ColorSelector</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model,@targetId)-&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@model</span> <span class="k">instanceof</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ColorSelector</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;model must be an instance of ColorSelector&quot;</span><span class="p">)</span>
    <span class="vi">@children = </span><span class="p">[]</span>
    <span class="nx">@eventDispatcher</span> <span class="o">=</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">()</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@children = </span><span class="p">[]</span>
    <span class="nv">currentColor = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Color</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">currentColor</span><span class="p">.</span><span class="nx">value</span><span class="p">)))</span>
    <span class="vi">@el = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">@el</span> <span class="o">+=</span><span class="s2">&quot;&lt;h4&gt;Current Color&lt;/h4&gt;&quot;</span>
    <span class="nx">@el</span> <span class="o">+=</span><span class="nx">currentColor</span><span class="p">.</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
    <span class="nx">@el</span> <span class="o">+=</span><span class="s2">&quot;&lt;h4&gt;Color swatch&lt;/h4&gt;&quot;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@model</span><span class="p">.</span><span class="nx">colors</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nx">@children</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Cell</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">colors</span><span class="p">[</span><span class="nx">i</span><span class="p">]))</span>
      <span class="nx">@el</span> <span class="o">+=</span><span class="nx">@children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">render</span><span class="p">().</span><span class="nx">el</span>
    <span class="vi">@targetId.innerHTML = </span><span class="nx">@el</span>
    <span class="vi">@targetId.onclick = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;cell&quot;</span> <span class="k">then</span> <span class="k">return</span>
      <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;colorchange&quot;</span><span class="p">),{</span><span class="s2">&quot;color&quot;</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span><span class="p">,</span><span class="s2">&quot;title&quot;</span><span class="o">:</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">title</span><span class="p">})</span>
    <span class="k">return</span> <span class="k">this</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CanvasPreview</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model)-&gt;</span>
  <span class="nx">render</span><span class="o">:</span><span class="nf">(localFactor)-&gt;</span>
    <span class="nv">gridModel = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">grid</span>
    <span class="nx">localFactor</span><span class="o">?=</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">innerHTML</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="nv">canvas = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">)</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span><span class="o">*</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">rows</span><span class="p">)</span>
    <span class="nx">canvas</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span><span class="o">*</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">columns</span><span class="p">)</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">canvas</span><span class="p">)</span>
    <span class="nv">ctx = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">)</span>
    <span class="nv">pointWidth = pointHeight = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">rows</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">j</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">columns</span><span class="p">]</span>
        <span class="nv">x = </span><span class="nx">j</span><span class="o">*</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span>
        <span class="nv">y = </span><span class="nx">i</span><span class="o">*</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span>
        <span class="k">if</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">color</span><span class="o">==</span><span class="kc">null</span> <span class="o">or</span> <span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">color</span><span class="o">==</span><span class="s2">&quot;&quot;</span>
          <span class="nv">ctx.fillStyle = </span><span class="s2">&quot;#FFFFFF&quot;</span>
          <span class="nv">ctx.globalAlpha = </span><span class="mi">0</span>
        <span class="k">else</span>
          <span class="nv">ctx.fillStyle = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">color</span>
          <span class="nv">ctx.globalAlpha = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">j</span><span class="p">].</span><span class="nx">alpha</span>
        <span class="nx">ctx</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="nx">y</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factor</span><span class="p">)</span>

    <span class="nx">@el</span><span class="o">=</span><span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">innerHTML</span>
    <span class="k">return</span> <span class="k">this</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">FactorSelector</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model)-&gt;</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@el = </span><span class="s2">&quot;&lt;p&gt;Zoom preview by :&lt;/p&gt;&quot;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">selectors</span>
      <span class="nx">@el</span><span class="o">+=</span><span class="s2">&quot;&lt;input type=&#39;radio&#39; name=&#39;factor&#39; #{&quot;</span><span class="nx">checked</span><span class="s2">&quot; unless i!= @model.factor}  value=&#39;#{i}&#39; /&gt; x #{i} &lt;br/&gt;&quot;</span>
    <span class="vi">@model.targetId.innerHTML = </span><span class="nx">@el</span>
    <span class="vi">@model.targetId.onclick = </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">name</span> <span class="o">!=</span> <span class="s2">&quot;factor&quot;</span>
        <span class="vi">@model.factor = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>
        <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;selectfactor&quot;</span><span class="p">),</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">value</span> <span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Menu</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model)-&gt;</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@model.targetId.innerHTML = </span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
      <span class="nv">button = </span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;input&quot;</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>button.innerText = @model.items[i].label</p>             </td>             <td class="code">               <div class="highlight"><pre>
      <span class="nx">button</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">label</span><span class="p">)</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span><span class="s2">&quot;button&quot;</span><span class="p">)</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">action</span><span class="p">)</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="p">)</span>
      <span class="nx">button</span><span class="p">.</span><span class="nx">dataset</span><span class="o">?=</span> <span class="p">{}</span>
      <span class="nv">button.dataset.id = </span><span class="nx">i</span>
      <span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span>
      <span class="nv">button.onclick = </span><span class="p">((</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
        <span class="nv">action = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">action</span>
        <span class="nv">datas = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">datas</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
          <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="nx">action</span><span class="p">),</span><span class="nx">datas</span><span class="p">)</span>
      <span class="p">)()</span>
      <span class="vi">@el = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">innerHTML</span>
    <span class="k">return</span> <span class="k">this</span>

<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Toolbox</span> <span class="k">extends</span> <span class="nx">View</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model,@targetId)-&gt;</span>
    <span class="vi">@eventDispatcher = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">EventDispatcher</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
  <span class="nx">render</span><span class="o">:-&gt;</span>
    <span class="vi">@el = </span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">tool</span> <span class="k">in</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">tools</span>
      <span class="nx">@el</span> <span class="o">+=</span> <span class="s2">&quot;&lt;img title=&#39;#{tool.title}&#39; name=&#39;#{tool.label}&#39; #{if tool.title == @model.currentTool.value then &quot;</span><span class="k">class</span><span class="o">=</span><span class="s1">&#39;selected&#39;</span><span class="s2">&quot; else &quot;&quot; } src=&#39;#{tool.src}&#39;/&gt;&quot;</span>
    <span class="nx">@el</span><span class="o">+=</span><span class="s2">&quot;&lt;br/&gt;&lt;h5&gt;#{@model.currentTool.value}&lt;/h5&gt;&quot;</span>
    <span class="nx">@targetId</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nv">name = </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
      <span class="nv">tagName = </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">tagName</span>
      <span class="nx">@eventDispatcher</span><span class="p">.</span><span class="nx">dispatch</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Event</span><span class="p">(</span><span class="s2">&quot;changetool&quot;</span><span class="p">),</span><span class="nx">name</span><span class="p">)</span> <span class="nx">unless</span> <span class="o">not</span> <span class="nx">name</span><span class="o">?</span> <span class="o">and</span> <span class="nx">tagName</span> <span class="o">!=</span> <span class="s2">&quot;IMG&quot;</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="vi">@targetId.innerHTML = </span><span class="nx">@el</span>
    <span class="k">return</span> <span class="k">this</span>

</pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h2>CONTROLLERS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controllers</span><span class="p">.</span><span class="nx">Application</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@model)-&gt;</span>
    <span class="vi">@view = </span><span class="kc">null</span>

</pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>MAIN</h2>             </td>             <td class="code">               <div class="highlight"><pre>
<span class="k">class</span> <span class="nx">Main</span>
  <span class="nx">constructor</span><span class="o">:-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;favicon builder at #{new Date()}&quot;</span>
    <span class="s2">&quot;use strict&quot;</span>
    <span class="vi">@version = </span><span class="mf">0.1</span>
</pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>DOM</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="vi">@thickbox = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;thickbox&quot;</span><span class="p">)</span>
    <span class="nv">$app = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">)</span>
    <span class="nv">$target = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
    <span class="nv">$canvasPreview = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;canvasPreview&quot;</span><span class="p">)</span>
    <span class="nv">$colorSelector = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;colorSelector&quot;</span><span class="p">)</span>
    <span class="nv">$menu = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;menu&quot;</span><span class="p">)</span>
    <span class="nv">$factorSelector = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;factorSelector&quot;</span><span class="p">)</span>
    <span class="nv">$title = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s2">&quot;title&quot;</span>
    <span class="nv">$toolbox = </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span> <span class="s2">&quot;toolSelector&quot;</span>
    <span class="nv">title = </span><span class="s2">&quot;Fav icon builder&quot;</span>

</pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>MODELS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="vi">@model = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Application</span><span class="p">()</span>
    <span class="vi">@model.defaultColor = </span><span class="p">{</span><span class="nx">value</span><span class="o">:</span><span class="s2">&quot;rgb(0,0,0)&quot;</span><span class="p">}</span>
    <span class="vi">@model.history = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">History</span><span class="p">()</span>
    <span class="vi">@model.toolbox = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Toolbox</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">Toolbox</span><span class="o">::</span><span class="nx">tools</span><span class="p">)</span>
    <span class="vi">@model.colorSelector = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">ColorSelector</span><span class="p">(</span><span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">DefaultColors</span><span class="o">::</span><span class="nx">colors</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">defaultColor</span><span class="p">)</span>
    <span class="vi">@model.grid = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Grid</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">16</span><span class="p">,</span><span class="mf">0.1</span><span class="p">,</span><span class="s2">&quot;new grid&quot;</span><span class="p">)</span>
    <span class="vi">@model.title = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Title</span><span class="p">(</span><span class="s2">&quot;new grid&quot;</span><span class="p">,</span><span class="nx">$title</span><span class="p">)</span>
    <span class="vi">@model.canvasPreview = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">CanvasPreview</span><span class="p">(</span><span class="nx">$canvasPreview</span><span class="p">,</span><span class="nx">@model</span><span class="p">)</span>
    <span class="vi">@model.factorSelector = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">FactorSelector</span><span class="p">(</span><span class="nx">$factorSelector</span><span class="p">,</span><span class="nx">@model</span><span class="p">.</span><span class="nx">canvasPreview</span><span class="p">.</span><span class="nx">factor</span><span class="p">)</span>
    <span class="vi">@model.menu = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Models</span><span class="p">.</span><span class="nx">Menu</span><span class="p">(</span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">DefaultMenu</span><span class="p">().</span><span class="nx">items</span><span class="p">,</span><span class="nx">$menu</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h2>CONTROLLERS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="vi">@applicationController = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Controllers</span><span class="p">.</span><span class="nx">Application</span><span class="p">(</span><span class="nx">@model</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h2>VIEWS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="vi">@view = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Application</span><span class="p">(</span><span class="nx">@applicationController</span><span class="p">,</span><span class="nx">$app</span><span class="p">)</span>
    <span class="vi">@view.toolbox = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Toolbox</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">toolbox</span><span class="p">,</span><span class="nx">$toolbox</span><span class="p">)</span>
    <span class="vi">@view.colorSelector = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">ColorSelector</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">colorSelector</span><span class="p">,</span><span class="nx">$colorSelector</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">colorSelector</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;colorchange&quot;</span><span class="p">,</span><span class="nx">@oncolorchange</span><span class="p">)</span>
    <span class="vi">@view.canvasPreview = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">CanvasPreview</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">canvasPreview</span><span class="p">)</span>
    <span class="vi">@view.factorSelector = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">FactorSelector</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">factorSelector</span><span class="p">)</span>
    <span class="vi">@view.grid = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Grid</span><span class="p">(</span><span class="nx">$target</span><span class="p">,</span><span class="nx">@model</span><span class="p">)</span>
    <span class="vi">@view.title = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Title</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">setPenColor</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">currentColor</span><span class="p">)</span>
    <span class="vi">@view.menu = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Views</span><span class="p">.</span><span class="nx">Menu</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">menu</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span> <span class="c1"># render all child views</span>
</pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h2>EVENTS</h2>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">toolbox</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;changetool&quot;</span><span class="p">,</span><span class="nx">@changeTool</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;exporttopng&quot;</span><span class="p">,</span><span class="nx">@exportCanvas</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;changegridsize&quot;</span><span class="p">,</span><span class="nx">@changegridsize</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;emptygrid&quot;</span><span class="p">,</span><span class="nx">@emptygrid</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;savetolocal&quot;</span><span class="p">,</span><span class="nx">@savetolocal</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;restorefromlocal&quot;</span><span class="p">,</span><span class="nx">@restoreFromLocal</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;showthickbox&quot;</span><span class="p">,</span><span class="nx">@showThickbox</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;undo&quot;</span><span class="p">,</span><span class="nx">@undo</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">menu</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;redo&quot;</span><span class="p">,</span><span class="nx">@redo</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">factorSelector</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;selectfactor&quot;</span><span class="p">,</span><span class="nx">@selecFactor</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;renderpreview&quot;</span><span class="p">,</span><span class="nx">@renderPreview</span><span class="p">)</span> <span class="c1"># rendercanvas preview</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;updateviews&quot;</span><span class="p">,</span><span class="nx">@updateViews</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;clickcell&quot;</span><span class="p">,</span><span class="nx">@clickcell</span><span class="p">)</span> <span class="c1"># user draw on a cell in the grid</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;pushinhistory&quot;</span><span class="p">,</span><span class="nx">@pushInHistory</span><span class="p">)</span> <span class="c1"># push grid state in history</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">eventDispatcher</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span><span class="s2">&quot;titlechanged&quot;</span><span class="p">,</span><span class="nx">@titleChange</span><span class="p">)</span> <span class="c1"># title of grid edited </span>

    <span class="nx">@pushInHistory</span><span class="p">()</span>

  <span class="nx">changeTool</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@model.toolbox.currentTool.value = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">pushInHistory</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="k">if</span>  <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">()</span>
      <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">)</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span><span class="p">)))</span>
    <span class="vi">@model.history.iterator.iter = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span>
  <span class="nx">undo</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">hasPrevious</span><span class="p">()</span>
      <span class="vi">@model.grid.grid = </span> <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">previous</span><span class="p">().</span><span class="nx">grid</span>
      <span class="nx">@updateViews</span><span class="p">()</span>
  <span class="nx">redo</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">hasNext</span><span class="p">()</span>
      <span class="vi">@model.grid.grid = </span> <span class="nx">@model</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">iterator</span><span class="p">.</span><span class="nx">next</span><span class="p">().</span><span class="nx">grid</span>
      <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">clickcell</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nv">bucket = </span><span class="k">new</span> <span class="nx">App</span><span class="p">.</span><span class="nx">Utils</span><span class="p">.</span><span class="nx">BucketTool</span><span class="p">()</span>
    <span class="nv">bucket.context = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span>
    <span class="nv">bucket.currentColor = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span>
    <span class="nv">bucket.newColor = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">colorSelector</span><span class="p">.</span><span class="nx">currentColor</span><span class="p">.</span><span class="nx">value</span>
    <span class="nv">bucket.point = </span><span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">row</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span><span class="nx">y</span><span class="o">:</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">column</span><span class="p">,</span><span class="mi">10</span><span class="p">)}</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;bucket&quot;</span><span class="p">,</span><span class="nx">bucket</span>
    <span class="nx">bucket</span><span class="p">.</span><span class="nx">fill</span><span class="p">(</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">context</span><span class="p">,</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">point</span><span class="p">,</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">currentColor</span><span class="p">,</span><span class="nx">bucket</span><span class="p">.</span><span class="nx">newColor</span><span class="p">)</span>
    <span class="nx">@updateViews</span><span class="p">()</span>
    <span class="nx">bucket</span> <span class="o">=</span><span class="kc">null</span>
</pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">fillCell</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">)</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">fillCell</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre>
  <span class="nx">titleChange</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@model.grid.title = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span>
    <span class="nx">@updateViews</span><span class="p">()</span>
  <span class="nx">renderPreview</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">canvasPreview</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">oncolorchange</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">arguments</span>
    <span class="vi">@model.colorSelector.currentColor.value = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">color</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">colorSelector</span><span class="p">.</span><span class="nx">currentColor</span>
</pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>@model.colorSelector.currentColor.title = e.datas.title</p>             </td>             <td class="code">               <div class="highlight"><pre>
    <span class="nx">@updateViews</span><span class="p">()</span>
  <span class="nx">exportCanvas</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">canvasPreview</span><span class="p">.</span><span class="nx">targetId</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;canvas&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toDataURL</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">))</span>
  <span class="nx">changegridsize</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@model.grid.rows = </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">rows</span>
    <span class="vi">@model.grid.columns= </span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">.</span><span class="nx">columns</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">fillGridBlank</span><span class="p">()</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">emptygrid</span><span class="o">:=&gt;</span>
    <span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span><span class="p">.</span><span class="nx">emptyGrid</span><span class="p">()</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">savetolocal</span><span class="o">:=&gt;</span>
    <span class="nv">backups = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">localStorage</span><span class="p">[</span><span class="s2">&quot;faviconbuilderGrid&quot;</span><span class="p">]</span>
      <span class="nv">backups = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s2">&quot;faviconbuilderGrid&quot;</span><span class="p">])</span>
    <span class="nx">backups</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">grid</span><span class="p">)</span>
    <span class="nv">backups.version = </span><span class="nx">@version</span>
    <span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s2">&quot;faviconbuilderGrid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">backups</span><span class="p">))</span> <span class="o">and</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Icon saved to local storage&quot;</span><span class="p">)</span>
  <span class="nx">restoreFromLocal</span><span class="o">:=&gt;</span>
    <span class="k">if</span> <span class="nx">localStorage</span><span class="p">[</span><span class="s2">&quot;faviconbuilderGrid&quot;</span><span class="p">]</span><span class="o">!=</span><span class="kc">null</span>
      <span class="nv">backups       = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="s2">&quot;faviconbuilderGrid&quot;</span><span class="p">])</span>
      <span class="nv">gridModel           = </span><span class="nx">backups</span><span class="p">[</span><span class="nx">backups</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="vi">@model.grid.grid    = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">grid</span>
      <span class="vi">@model.grid.rows    = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">rows</span>
      <span class="vi">@model.grid.columns = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">columns</span>
      <span class="vi">@model.grid.version = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">version</span>
      <span class="vi">@model.title.value  = </span><span class="nx">gridModel</span><span class="p">.</span><span class="nx">title</span>
      <span class="nx">@updateViews</span><span class="p">()</span>
  <span class="nx">updateViews</span><span class="o">:=&gt;</span>
    <span class="nx">@view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
  <span class="nx">selecFactor</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@model.canvasPreview.factor = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">datas</span><span class="p">)</span>
    <span class="nx">@updateViews</span><span class="p">()</span>
  <span class="nx">showThickbox</span><span class="o">:</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
    <span class="vi">@thickbox.style.visibility = </span><span class="k">if</span> <span class="nx">@thickbox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">visibility</span> <span class="o">==</span> <span class="s2">&quot;hidden&quot;</span> <span class="k">then</span> <span class="s2">&quot;visible&quot;</span> <span class="k">else</span> <span class="s2">&quot;hidden&quot;</span>
    <span class="vi">@thickbox.style.opacity = </span><span class="k">if</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">@thickbox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">1</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="vi">@thickbox.onclick= </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="o">=&gt;</span>
      <span class="nx">@showThickbox</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>

<span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nv">onload = </span><span class="o">-&gt;</span>
  <span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nv">main = </span><span class="k">new</span> <span class="nx">Main</span><span class="p">()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 